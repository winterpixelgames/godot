if get_option('builtin_icu')
    _builtin_icu_incdirs = include_directories('common')

    _builtin_icu_srcs = files([
        'common/appendable.cpp',
        'common/bmpset.cpp',
        'common/brkeng.cpp',
        'common/brkiter.cpp',
        'common/bytesinkutil.cpp',
        'common/bytestream.cpp',
        'common/bytestrie.cpp',
        'common/bytestriebuilder.cpp',
        'common/bytestrieiterator.cpp',
        'common/caniter.cpp',
        'common/characterproperties.cpp',
        'common/chariter.cpp',
        'common/charstr.cpp',
        'common/cmemory.cpp',
        'common/cstr.cpp',
        'common/cstring.cpp',
        'common/cwchar.cpp',
        'common/dictbe.cpp',
        'common/dictionarydata.cpp',
        'common/dtintrv.cpp',
        'common/edits.cpp',
        'common/errorcode.cpp',
        'common/filteredbrk.cpp',
        'common/filterednormalizer2.cpp',
        'common/icudataver.cpp',
        'common/icuplug.cpp',
        'common/loadednormalizer2impl.cpp',
        'common/localebuilder.cpp',
        'common/localematcher.cpp',
        'common/localeprioritylist.cpp',
        'common/locavailable.cpp',
        'common/locbased.cpp',
        'common/locdispnames.cpp',
        'common/locdistance.cpp',
        'common/locdspnm.cpp',
        'common/locid.cpp',
        'common/loclikely.cpp',
        'common/loclikelysubtags.cpp',
        'common/locmap.cpp',
        'common/locresdata.cpp',
        'common/locutil.cpp',
        'common/lsr.cpp',
        'common/messagepattern.cpp',
        'common/normalizer2.cpp',
        'common/normalizer2impl.cpp',
        'common/normlzr.cpp',
        'common/parsepos.cpp',
        'common/patternprops.cpp',
        'common/pluralmap.cpp',
        'common/propname.cpp',
        'common/propsvec.cpp',
        'common/punycode.cpp',
        'common/putil.cpp',
        'common/rbbi.cpp',
        'common/rbbi_cache.cpp',
        'common/rbbidata.cpp',
        'common/rbbinode.cpp',
        'common/rbbirb.cpp',
        'common/rbbiscan.cpp',
        'common/rbbisetb.cpp',
        'common/rbbistbl.cpp',
        'common/rbbitblb.cpp',
        'common/resbund.cpp',
        'common/resbund_cnv.cpp',
        'common/resource.cpp',
        'common/restrace.cpp',
        'common/ruleiter.cpp',
        'common/schriter.cpp',
        'common/serv.cpp',
        'common/servlk.cpp',
        'common/servlkf.cpp',
        'common/servls.cpp',
        'common/servnotf.cpp',
        'common/servrbf.cpp',
        'common/servslkf.cpp',
        'common/sharedobject.cpp',
        'common/simpleformatter.cpp',
        'common/static_unicode_sets.cpp',
        'common/stringpiece.cpp',
        'common/stringtriebuilder.cpp',
        'common/uarrsort.cpp',
        'common/ubidi.cpp',
        'common/ubidi_props.cpp',
        'common/ubidiln.cpp',
        'common/ubiditransform.cpp',
        'common/ubidiwrt.cpp',
        'common/ubrk.cpp',
        'common/ucase.cpp',
        'common/ucasemap.cpp',
        'common/ucasemap_titlecase_brkiter.cpp',
        'common/ucat.cpp',
        'common/uchar.cpp',
        'common/ucharstrie.cpp',
        'common/ucharstriebuilder.cpp',
        'common/ucharstrieiterator.cpp',
        'common/uchriter.cpp',
        'common/ucln_cmn.cpp',
        'common/ucmndata.cpp',
        'common/ucnv.cpp',
        'common/ucnv2022.cpp',
        'common/ucnv_bld.cpp',
        'common/ucnv_cb.cpp',
        'common/ucnv_cnv.cpp',
        'common/ucnv_ct.cpp',
        'common/ucnv_err.cpp',
        'common/ucnv_ext.cpp',
        'common/ucnv_io.cpp',
        'common/ucnv_lmb.cpp',
        'common/ucnv_set.cpp',
        'common/ucnv_u16.cpp',
        'common/ucnv_u32.cpp',
        'common/ucnv_u7.cpp',
        'common/ucnv_u8.cpp',
        'common/ucnvbocu.cpp',
        'common/ucnvdisp.cpp',
        'common/ucnvhz.cpp',
        'common/ucnvisci.cpp',
        'common/ucnvlat1.cpp',
        'common/ucnvmbcs.cpp',
        'common/ucnvscsu.cpp',
        'common/ucnvsel.cpp',
        'common/ucol_swp.cpp',
        'common/ucptrie.cpp',
        'common/ucurr.cpp',
        'common/udata.cpp',
        'common/udatamem.cpp',
        'common/udataswp.cpp',
        'common/uenum.cpp',
        'common/uhash.cpp',
        'common/uhash_us.cpp',
        'common/uidna.cpp',
        'common/uinit.cpp',
        'common/uinvchar.cpp',
        'common/uiter.cpp',
        'common/ulist.cpp',
        'common/uloc.cpp',
        'common/uloc_keytype.cpp',
        'common/uloc_tag.cpp',
        'common/umapfile.cpp',
        'common/umath.cpp',
        'common/umutablecptrie.cpp',
        'common/umutex.cpp',
        'common/unames.cpp',
        'common/unifiedcache.cpp',
        'common/unifilt.cpp',
        'common/unifunct.cpp',
        'common/uniset.cpp',
        'common/uniset_closure.cpp',
        'common/uniset_props.cpp',
        'common/unisetspan.cpp',
        'common/unistr.cpp',
        'common/unistr_case.cpp',
        'common/unistr_case_locale.cpp',
        'common/unistr_cnv.cpp',
        'common/unistr_props.cpp',
        'common/unistr_titlecase_brkiter.cpp',
        'common/unorm.cpp',
        'common/unormcmp.cpp',
        'common/uobject.cpp',
        'common/uprops.cpp',
        'common/ures_cnv.cpp',
        'common/uresbund.cpp',
        'common/uresdata.cpp',
        'common/usc_impl.cpp',
        'common/uscript.cpp',
        'common/uscript_props.cpp',
        'common/uset.cpp',
        'common/uset_props.cpp',
        'common/usetiter.cpp',
        # 'common/ushape.cpp',
        'common/usprep.cpp',
        'common/ustack.cpp',
        'common/ustr_cnv.cpp',
        'common/ustr_titlecase_brkiter.cpp',
        'common/ustr_wcs.cpp',
        'common/ustrcase.cpp',
        'common/ustrcase_locale.cpp',
        'common/ustrenum.cpp',
        'common/ustrfmt.cpp',
        'common/ustring.cpp',
        'common/ustrtrns.cpp',
        'common/utext.cpp',
        'common/utf_impl.cpp',
        'common/util.cpp',
        'common/util_props.cpp',
        'common/utrace.cpp',
        'common/utrie.cpp',
        'common/utrie2.cpp',
        'common/utrie2_builder.cpp',
        'common/utrie_swap.cpp',
        'common/uts46.cpp',
        'common/utypes.cpp',
        'common/uvector.cpp',
        'common/uvectr32.cpp',
        'common/uvectr64.cpp',
        'common/wintz.cpp',
    ])

    _icu_data_name = 'icudt68l.dat'

    _builtin_icu_compile_dep_flags = [
        '-DU_STATIC_IMPLEMENTATION',
        '-DU_COMMON_IMPLEMENTATION',
        '-DUCONFIG_NO_COLLATION',
        '-DUCONFIG_NO_CONVERSION',
        '-DUCONFIG_NO_FORMATTING',
        '-DUCONFIG_NO_SERVICE',
        '-DUCONFIG_NO_IDNA',
        '-DUCONFIG_NO_FILE_IO',
        '-DUCONFIG_NO_TRANSLITERATION',
        '-DICU_DATA_NAME=' + _icu_data_name,
    ]

    _builtin_icu_compile_flags = []

    if meson.get_compiler('cpp').get_id() == 'gcc'
        _builtin_icu_compile_flags += '-Wno-stringop-overflow'
    endif

    lib_builtin_icu = static_library('builtin_icu4c', _builtin_icu_srcs,
        include_directories: _builtin_icu_incdirs,
        cpp_args: [_builtin_icu_compile_flags, _builtin_icu_compile_dep_flags],
        build_by_default: false
    )

    DEP_ICU = declare_dependency(
        link_with: lib_builtin_icu,
        include_directories: _builtin_icu_incdirs,
        compile_args: _builtin_icu_compile_dep_flags,
        variables: {
            'icu_data_name': _icu_data_name,
        }
    )
else
    DEP_ICU = dependency('icu-uc')
endif