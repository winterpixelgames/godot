# no _ on name, there is a subdir that needs this
oidn_srcs = files([
    'core/api.cpp',
    'core/device.cpp',
    'core/filter.cpp',
    'core/network.cpp',
    'core/autoencoder.cpp',
    'core/transfer_function.cpp',
    'mkl-dnn/src/common/batch_normalization.cpp',
    'mkl-dnn/src/common/concat.cpp',
    'mkl-dnn/src/common/convolution.cpp',
    'mkl-dnn/src/common/convolution_pd.cpp',
    'mkl-dnn/src/common/deconvolution.cpp',
    'mkl-dnn/src/common/eltwise.cpp',
    'mkl-dnn/src/common/engine.cpp',
    'mkl-dnn/src/common/inner_product.cpp',
    'mkl-dnn/src/common/inner_product_pd.cpp',
    'mkl-dnn/src/common/lrn.cpp',
    'mkl-dnn/src/common/memory.cpp',
    'mkl-dnn/src/common/memory_desc_wrapper.cpp',
    'mkl-dnn/src/common/mkldnn_debug.cpp',
    'mkl-dnn/src/common/mkldnn_debug_autogenerated.cpp',
    'mkl-dnn/src/common/pooling.cpp',
    'mkl-dnn/src/common/primitive.cpp',
    'mkl-dnn/src/common/primitive_attr.cpp',
    'mkl-dnn/src/common/primitive_desc.cpp',
    'mkl-dnn/src/common/primitive_exec_types.cpp',
    'mkl-dnn/src/common/primitive_iterator.cpp',
    'mkl-dnn/src/common/query.cpp',
    'mkl-dnn/src/common/reorder.cpp',
    'mkl-dnn/src/common/rnn.cpp',
    'mkl-dnn/src/common/scratchpad.cpp',
    'mkl-dnn/src/common/shuffle.cpp',
    'mkl-dnn/src/common/softmax.cpp',
    'mkl-dnn/src/common/stream.cpp',
    'mkl-dnn/src/common/sum.cpp',
    'mkl-dnn/src/common/utils.cpp',
    'mkl-dnn/src/common/verbose.cpp',
    'mkl-dnn/src/cpu/cpu_barrier.cpp',
    'mkl-dnn/src/cpu/cpu_concat.cpp',
    'mkl-dnn/src/cpu/cpu_engine.cpp',
    'mkl-dnn/src/cpu/cpu_memory.cpp',
    'mkl-dnn/src/cpu/cpu_reducer.cpp',
    'mkl-dnn/src/cpu/cpu_reorder.cpp',
    'mkl-dnn/src/cpu/cpu_sum.cpp',
    'mkl-dnn/src/cpu/jit_avx2_conv_kernel_f32.cpp',
    'mkl-dnn/src/cpu/jit_avx2_convolution.cpp',
    'mkl-dnn/src/cpu/jit_avx512_common_conv_kernel.cpp',
    'mkl-dnn/src/cpu/jit_avx512_common_conv_winograd_kernel_f32.cpp',
    'mkl-dnn/src/cpu/jit_avx512_common_convolution.cpp',
    'mkl-dnn/src/cpu/jit_avx512_common_convolution_winograd.cpp',
    'mkl-dnn/src/cpu/jit_avx512_core_fp32_wino_conv_2x3.cpp',
    'mkl-dnn/src/cpu/jit_avx512_core_fp32_wino_conv_4x3.cpp',
    'mkl-dnn/src/cpu/jit_avx512_core_fp32_wino_conv_4x3_kernel.cpp',
    'mkl-dnn/src/cpu/jit_sse42_conv_kernel_f32.cpp',
    'mkl-dnn/src/cpu/jit_sse42_convolution.cpp',
    'mkl-dnn/src/cpu/jit_transpose_src_utils.cpp',
    'mkl-dnn/src/cpu/jit_uni_eltwise.cpp',
    'mkl-dnn/src/cpu/jit_uni_pool_kernel_f32.cpp',
    'mkl-dnn/src/cpu/jit_uni_pooling.cpp',
    'mkl-dnn/src/cpu/jit_uni_reorder.cpp',
    'mkl-dnn/src/cpu/jit_uni_reorder_utils.cpp',
    'mkl-dnn/src/cpu/jit_utils/jit_utils.cpp',
    'mkl-dnn/src/cpu/jit_utils/jitprofiling/jitprofiling.c',
    'common/platform.cpp',
    'common/thread.cpp',
    'common/tensor.cpp',
])

# generate the lightmapper cpp weights
subdir('weights')

_oidn_cpp_args = [
    '-DOIDN_STATIC_LIB',
    '-DMKLDNN_THR=MKLDNN_THR_SEQ',
    '-D__STDC_CONSTANT_MACROS',
    '-D__STDC_LIMIT_MACROS',
    '-DDISABLE_VERBOSE',
    '-DMKLDNN_ENABLE_CONCURRENT_EXEC',
    # Do we always want to add this to oidn?
    '-DNDEBUG',
    '-DNOMINMAX'
]

if meson.get_compiler('cpp').get_id() == 'msvc'
    _oidn_cpp_args += ['/wd4068']
endif

_lib_oidn = static_library('builtin_oidn', oidn_srcs,
    include_directories: include_directories(
        '.',
        'include',
        'mkl-dnn/include',
        'mkl-dnn/src',
        'mkl-dnn/src/common',
        'mkl-dnn/src/cpu/xbyak',
        'mkl-dnn/src/cpu',
    ),
    cpp_args: _oidn_cpp_args,
    build_by_default: false
)

DEP_OIDN = declare_dependency(link_with: _lib_oidn,
    include_directories: include_directories('include'),
    compile_args: ['-DOIDN_STATIC_LIB']
)

